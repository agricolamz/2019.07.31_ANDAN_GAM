---
output: 
  html_document:
    toc: true
    toc_position: right
    toc_depth: 3
    toc_float: yes
    smooth_scroll: false
    number_sections: true
    self_contained: yes
    code_folding: show
    df_print: paged
editor_options: 
  chunk_output_type: console
---

* [Последняя версия](https://agricolamz.github.io/2019.07.31_ANDAN_GAM/index.html)
* [Исходный код](https://github.com/agricolamz/2019.07.31_ANDAN_GAM)

```{r, include=FALSE, hide = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, fig.width = 9, fig.height = 5)
```

```{r}
library(tidyverse)
library(splines)
library(mgcv)

theme_set(theme_minimal()+theme(legend.position = "bottom"))
```

```{r, include=FALSE, eval=FALSE}
# logo
set.seed(42)
tibble(x = seq(0, 0.5, length.out = 500),
       y = 0.2*x^9*(10*(1-x))^6+10*(10*x)^2*(1-x)^10+rnorm(500, sd = 1.5)) %>% 
  ggplot(aes(x, y))+
  geom_point()+
  geom_smooth(method = "lm", se = FALSE, size = 2)+
  geom_smooth(se = FALSE, color = "red", size = 2)+
  theme_minimal()+
  theme(axis.title = element_blank(),
        axis.text = element_blank())
```

# Полиномы, сплайны, GAM

[![](image/01_tweet.png)](https://twitter.com/ucfagls/status/842444686513991680)

## Введение

Давайте на этой паре будем работать с таким абстрактным полиномом:
```{r}
set.seed(42)
poly <- tibble(x = seq(0, 0.5, length.out = 500),
               y = 0.2*x^9*(10*(1-x))^6+10*(10*x)^2*(1-x)^10+rnorm(500, sd = 1.5))

poly %>% 
  ggplot(aes(x, y))+
  geom_point()
```


## Полиномы

$y_i = \sum_{j=0}^k \beta_j \times x^j_i + \epsilon_i = \beta_0 \times x^0_0 + \beta_1 \times x^1_i + ... \beta_k \times x^k_i + \epsilon_i$

```{r}
poly_fit1 <- lm(y ~ poly(x, 2, raw = TRUE), data = poly)
poly_fit2 <- lm(y ~ x+I(x^2), data = poly)

summary(poly_fit1)
summary(poly_fit2)

poly_fit2_values <- tibble(x = poly$x,
                           fit = poly_fit2$fitted.values)

poly %>% 
  ggplot(aes(x, y))+
  geom_point()+
  geom_line(data = poly_fit2_values, aes(x = x, y = fit), color = "blue", size = 2)+
  labs(caption = poly_fit2$call)

poly_fit3 <- lm(y ~ x+I(x^2)+I(x^3), data = poly)

poly_fit3_values <- tibble(x = poly$x,
                           fit = poly_fit3$fitted.values)

summary(poly_fit3)

poly %>% 
  ggplot(aes(x, y))+
  geom_point()+
  geom_line(data = poly_fit3_values, aes(x = x, y = fit), color = "blue", size = 2)+
  labs(caption = poly_fit3$call)
```

> Загрузите данные по продаже шампуня [(Makridakis, Wheelwright and Hyndman 1998)](https://www.kaggle.com/djokester/sales-of-shampoo-over-a-three-year-period). Визуализируйте данные и оцените полиномом какой степени нужно описывать эти данные? В ответ введите степень.



## Сплайны

```{r, fig.height=8}
library(splines)
poly_fit3 <- lm(y ~ bs(x), data = poly)
summary(poly_fit3)

poly_fit3_values <- tibble(x = poly$x,
                           fit = poly_fit3$fitted.values)
poly %>% 
  ggplot(aes(x, y))+
  geom_point()+
  geom_line(data = poly_fit3_values, aes(x = x, y = fit), color = "blue", size = 2)+
  labs(caption = poly_fit3$call) ->
  p1

as_tibble(cbind(bs(poly$x), x = poly$x)) %>% 
  gather(spline, value, -x) %>% 
  ggplot(aes(x, value, color = spline))+
  geom_line() ->
  s1

gridExtra::grid.arrange(p1, s1)

poly_fit4 <- lm(y ~ bs(x, df = 6), data = poly)
summary(poly_fit4)

poly_fit4_values <- tibble(x = poly$x,
                           fit = poly_fit4$fitted.values)
poly %>% 
  ggplot(aes(x, y))+
  geom_point()+
  geom_line(data = poly_fit4_values, aes(x = x, y = fit), color = "blue", size = 2)+
  labs(caption = poly_fit4$call) ->
  p2

as_tibble(cbind(bs(poly$x, df=6), x = poly$x)) %>% 
  gather(spline, value, -x) %>% 
  ggplot(aes(x, value, color = spline))+
  geom_line() ->
  s2

gridExtra::grid.arrange(p2, s2)
```


## GAM

### Что такое GAM

Согласно теореме Колмогорова -- Арнольда, каждая непрерывная функция может быть представлена в виде композиции непрерывных функций одной переменной. Композиция --- применение одной функции к результатам другой: $(G\circ F)(x) = G(F(x))$. Подробнее см. [лекции Виктора Клепцына](https://forany.xyz/a-453).




### Ваш первый GAM

```{r}
library(mgcv)
poly_fit4 <- gam(y ~ s(x), data = poly)
summary(poly_fit4)

fitted <- tibble(x = poly$x,
                 fit = poly_fit4$fitted.values)

poly %>% 
  ggplot(aes(x, y))+
  geom_point()+
  geom_line(data = fitted, aes(x = x, y = fit), color = "blue")+
  labs(caption = poly_fit4$call)
```

### Формулы в GAM

### Параметры сглаживания

### Количество базовых функций

### `gam.check()`

### Проверка на concurvity

